name: ğŸ—ï¸ Build and Release macOS App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  build-macos-app:
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸº Install Homebrew dependencies
        run: |
          brew install python-tk

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app Pillow

      - name: ğŸ¨ Create app icon
        run: |
          source .venv/bin/activate
          python create_icon.py

      - name: ğŸ—ï¸ Build macOS app
        run: |
          source .venv/bin/activate
          python setup.py py2app

      - name: ğŸ“¦ Create distribution package
        run: |
          chmod +x create_package.sh
          ./create_package.sh

      - name: ğŸ” Verify build
        run: |
          ls -la "dist/Monitor Layout Manager.app"
          ls -la Monitor-Layout-Manager-*.zip

      - name: ğŸ“¤ Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Monitor-Layout-Manager-v1.0.0-macOS.zip
          name: Monitor Layout Manager ${{ github.ref_name }}
          body: |
            # ğŸ–¥ï¸ Monitor Layout Manager ${{ github.ref_name }}

            ## ğŸš€ Ready-to-Run macOS App

            **Download and Extract**: Just download the ZIP, extract it, and double-click the `.app` file!

            ### âœ¨ What's New
            - Standalone macOS app bundle with icon
            - No installation or dependencies required
            - Drag-and-drop monitor layout management
            - Custom named layouts ("Home", "Work", etc.)
            - HiDPI support for Retina displays

            ### ğŸ“‹ Requirements
            - macOS 10.15+ (Catalina or newer)
            - No additional software needed

            ### ğŸ”’ Security
            - If you see a security warning, go to **System Settings > Privacy & Security** and click **"Open Anyway"**
            - The app will request permission to control display settings - click **"Allow"**

            ### ğŸ’¡ Usage
            1. Double-click `Monitor Layout Manager.app`
            2. Drag monitors in the visual interface to arrange them
            3. Save layouts with descriptive names
            4. Switch between layouts using the dropdown

            ---

            *Created by Artur Grochau*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Build Summary
        run: |
          echo "âœ… macOS app build completed successfully!"
          echo "ğŸ“± App bundle created: dist/Monitor Layout Manager.app"
          echo "ğŸ“¦ Distribution ZIP: $(ls Monitor-Layout-Manager-*.zip)"
          echo "ğŸ“ Size: $(ls -lah Monitor-Layout-Manager-*.zip | awk '{print $5}')"
